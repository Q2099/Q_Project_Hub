document.addEventListener("DOMContentLoaded", function() {

  function updateSummary() {
    const e = document.getElementById("iataFrom"),
          t = document.getElementById("city"),
          n = document.getElementById("outboundDate"),
          a = document.getElementById("returnDate"),
          u = document.getElementById("cc_sb3_sb3_flighthotel_sb3_flight_airlines_0"),
          r = document.getElementById("cc_sb3_sb3_flighthotel_sb3_flight_classofservice"),
          o = document.getElementById("cc_sb3_sb3_flighthotel_flighthotel_numGuests1"),
          d = document.getElementById("cc_sb3_sb3_flighthotel_flighthotel_numGuests2"),
          i = document.getElementById("cc_sb3_sb3_flighthotel_flighthotel_numGuests3");

    const s = e?.value || "",
          c = t?.value || "",
          m = n?.value || "",
          v = a?.value || "",
          f = u?.value || "",
          h = r?.value || "",
          p = o?.value || "",
          y = d?.value || "",
          b = i?.value || "";

    let guestsSummary = `${p} in Room 1`;
    if (y) guestsSummary += `, ${y} in Room 2`;
    if (b) guestsSummary += `, ${b} in Room 3`;

    const summaryText = `${s} → ${c} | ${m} → ${v} | ${(f || "Any Airline")} | Class: ${h} | Guests: ${guestsSummary}`;
    const summaryBox = document.getElementById("summary");
    if (summaryBox) summaryBox.value = summaryText;
  }

  // Helper: safely attach onchange attributes
  function setOnChange(id, handler) {
    const el = document.getElementById(id);
    if (el) el.setAttribute("onchange", handler);
  }

  // Attach listeners to static elements
  setOnChange("cc_sb3_sb3_flighthotel_sb3_flight_airlines_0", "updateSummary()");
  setOnChange("cc_sb3_sb3_flighthotel_sb3_flight_classofservice", "updateSummary()");

  // Dynamically re-attach listeners when room count changes
  const numRoomsEl = document.getElementById("numRooms");
  if (numRoomsEl) {
    numRoomsEl.addEventListener("change", () => {
      attachRoomListeners();
      updateSummary();
    });
  }

  // Function to attach onchange handlers for guest dropdowns
  function attachRoomListeners() {
    const roomMap = {
      1: "cc_sb3_sb3_flighthotel_flighthotel_numGuests1",
      2: "cc_sb3_sb3_flighthotel_flighthotel_numGuests2",
      3: "cc_sb3_sb3_flighthotel_flighthotel_numGuests3"
    };

    Object.entries(roomMap).forEach(([roomNum, id]) => {
      const el = document.getElementById(id);
      if (el && el.offsetParent !== null) { // Only attach if visible
        el.onchange = function() {
          updateAges(Number(roomNum));
          updateSummary();
        };
      }
    });
  }

  // Run initially after page load
  attachRoomListeners();

  // Global listener for inputs & selects to update summary in real time
  const allInputs = document.querySelectorAll("input, select");
  allInputs.forEach(el => {
    el.addEventListener("input", updateSummary);
    el.addEventListener("change", updateSummary);
  });

  // For autosuggest clicks
  document.addEventListener("click", e => {
    if (e.target.classList.contains("suggestion-item")) {
      setTimeout(updateSummary, 100);
    }
  });

  // Initial summary display
  updateSummary();
});
